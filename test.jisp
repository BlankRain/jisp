(= fs (require "fs"))

(= files `("index"
           "toplevel"
           "util"
           "operators"
           "tokenise"
           "lex"
           "parse"
           "register"
           "repl"
           "optparse"
           "command"
           "macros"
           "jisp"
           "browser"))

(= filesBrowser `("util"
                  "toplevel"
                  "util"
                  "operators"
                  "tokenise"
                  "lex"
                  "parse"
                  "macros"
                  "jisp"
                  "browser"))

; Load compiler
(console.log "-- trying to load compiler...")
(= jisp      (require "./lib/jisp/jisp"))

(def buildFile compiler filename (do
     (= srcPath   (+ "./src/" filename ".jisp")
        destpath  (+ "./dev/jisp/" filename ".js")
        src       (fs.readFileSync srcPath "utf8"))
     (console.log (+ "-- compiling " filename "..."))
     (= js (compiler.compile src))
     (fs.writeFileSync destpath js "utf8")))

(def build jisp (do
     (console.log "-- building...")
     (for filename files (buildFile jisp filename))
     (console.log "-- if you're reading this, compilation has succeeded!")))

(build jisp)

; Building with unstable

(console.log "-- trying to load unstable compiler...")
(= jisp_unstable (require "./dev/jisp/jisp"))

(console.log "-- trying to build with unstable compiler...")
(build jisp_unstable)
(build jisp_unstable)

(console.log "-- to test the unstable version, disable the stable or use another compile script")

; Build the concatenated version for the browser
; Copied from the CoffeeScript cakefile

(= code "")

(for name filesBrowser
  (+= code (+
    "require['./" name "'] = (function() {
      var exports = {}, module = {exports: exports};
      " (fs.readFileSync (+ "./dev/jisp/" name ".js")) "
      return module.exports;
    })();")))

(= code (+
  "(function(root) {
    var jisp = function() {
      function require(path) { return require[path]; }
      " code "
      return require['./jisp'];
    }();
    root.jisp = jisp;
  }(this));"))

(fs.writeFileSync "./browser/jisp.js" code)
(console.log "-- if you're reading this, concat build has succeeded!")
